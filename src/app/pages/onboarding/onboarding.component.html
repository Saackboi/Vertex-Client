
<!-- Header -->
<header class="onboarding-header">
  <div class="header-container">
    <!-- Logo -->
    <app-logo route="/dashboard" />

    <!-- Navigation -->
    <div class="nav-section">
      <nav class="nav-links">
        <a (click)="navigateToNotifications()">Notificaciones</a>
      </nav>

      <div class="action-buttons">
        <button class="icon-button" (click)="toggleDarkMode()">
          <span nz-icon [nzType]="isDarkMode ? 'sun' : 'moon'" nzTheme="outline"></span>
        </button>
        <button class="icon-button" (click)="navigateToNotifications()">
          <nz-badge [nzCount]="(notificationCount$ | async) ?? 0">
            <span nz-icon nzType="bell" nzTheme="outline"></span>
          </nz-badge>
        </button>
        <nz-avatar 
          nz-dropdown 
          [nzDropdownMenu]="userMenu" 
          nzPlacement="bottomRight"
          nzIcon="user" 
          [nzSize]="32"
          class="user-avatar">
        </nz-avatar>
        <nz-dropdown-menu #userMenu="nzDropdownMenu">
          <ul nz-menu>
            <li nz-menu-item>
              <span nz-icon nzType="user" nzTheme="outline"></span>
              {{ userFullName$ | async }}
            </li>
            <li nz-menu-divider></li>
            <li nz-menu-item (click)="logout()">
              <span nz-icon nzType="logout" nzTheme="outline"></span>
              Cerrar Sesión
            </li>
          </ul>
        </nz-dropdown-menu>
      </div>
    </div>
  </div>
</header>

<!-- Main Content -->
<main class="onboarding-main">
  <!-- Alerta de Error -->
  @if ((errorMessage$ | async)) {
    <div class="error-alert-container">
      <nz-alert
        nzType="error"
        [nzMessage]="(errorMessage$ | async)"
        nzShowIcon
        nzCloseable
        (nzOnClose)="clearError()"
        class="error-alert"
      ></nz-alert>
    </div>
  }

  <!-- Alerta de Onboarding Completado -->
  @if ((isCompleted$ | async)) {
    <div class="completed-container">
      <!-- Hero Section -->
      <div class="completed-hero">
        <div class="hero-icon">
          <span nz-icon nzType="check-circle" nzTheme="fill"></span>
        </div>
        <div class="hero-text">
          <h1 class="hero-title">¡Perfil Completado!</h1>
          <p class="hero-description">
            Tu perfil profesional está listo y visible para reclutadores.
          </p>
        </div>
      </div>

      <div class="profile-bento">
        <div class="bento-card bento-summary">
          <div class="bento-title">
            <span nz-icon nzType="idcard" nzTheme="outline"></span>
            Resumen profesional
          </div>
          <h3 class="bento-name">{{ accountForm.get('fullName')?.value || 'No especificado' }}</h3>
          <p class="bento-text">
            {{ accountForm.get('summary')?.value || 'No especificado' }}
          </p>
        </div>

        <div class="bento-card bento-stats">
          <div class="bento-title">
            <span nz-icon nzType="check-circle" nzTheme="outline"></span>
            Estado del perfil
          </div>
          <div class="bento-stat-grid">
            <div class="bento-stat">
              <span class="stat-label">Experiencias</span>
              <span class="stat-value">{{ experiences.length }}</span>
            </div>
            <div class="bento-stat">
              <span class="stat-label">Habilidades</span>
              <span class="stat-value">{{ skills.length }}</span>
            </div>
          </div>
        </div>

        <div class="bento-card bento-experience">
          <div class="bento-title">
            <span nz-icon nzType="solution" nzTheme="outline"></span>
            Experiencia Laboral
          </div>
          @if (experiences.length > 0) {
            <div class="bento-experience-list">
              @for (exp of experiences.controls; track $index) {
                <div class="bento-exp-item">
                  <div class="bento-exp-main">
                    <span class="bento-exp-role">{{ exp.get('jobTitle')?.value || 'Sin titulo' }}</span>
                    <span class="bento-exp-company">{{ exp.get('company')?.value || 'Sin empresa' }}</span>
                  </div>
                  <span class="bento-exp-date">
                    {{ exp.get('startDate')?.value || 'Inicio' }} -
                    {{ exp.get('isCurrent')?.value ? 'Presente' : (exp.get('endDate')?.value || 'Fin') }}
                  </span>
                </div>
              }
            </div>
          } @else {
            <p class="bento-empty">No hay experiencias registradas.</p>
          }
        </div>

        <div class="bento-card bento-skills">
          <div class="bento-title">
            <span nz-icon nzType="tags" nzTheme="outline"></span>
            Habilidades
          </div>
          @if (skills && skills.length > 0) {
            <div class="bento-skills-tags">
              @for (skill of skills; track skill) {
                <span class="bento-skill">{{ skill }}</span>
              }
            </div>
          } @else {
            <p class="bento-empty">Agrega habilidades para destacar tu perfil.</p>
          }
        </div>

        <div class="bento-card bento-actions">
          <div class="bento-title">
            <span nz-icon nzType="home" nzTheme="outline"></span>
            Acciones rápidas
          </div>
          <button nz-button nzType="primary" nzSize="large" (click)="navigateToDashboard()">
            Ir al inicio
          </button>
          <p class="bento-hint">Puedes volver a editar tu perfil cuando quieras.</p>
        </div>

        <div class="bento-card bento-info">
          <div class="bento-title">
            <span nz-icon nzType="info-circle" nzTheme="outline"></span>
            Consejo
          </div>
          <p>¿Necesitas hacer cambios? Puedes editar tu perfil en cualquier momento desde la sección de <strong>Perfil</strong>.</p>
        </div>
      </div>
    </div>
  }

  <!-- Page Header -->
  <div class="page-header" [class.hidden]="(isCompleted$ | async)">
    <div class="page-title-section">
      <h1 class="page-title">Configuración de Cuenta</h1>
      @if ((isCompleted$ | async)) {
        <span class="completed-badge">
          <span nz-icon nzType="check-circle" nzTheme="fill"></span>
          Completado
        </span>
      }
    </div>
    @if ((lastSaved$ | async) && !(isCompleted$ | async)) {
      <div class="autosave-badge">
        <span nz-icon nzType="check-circle" nzTheme="outline"></span>
        <span class="badge-text">Borrador guardado automáticamente {{ (lastSaved$ | async) }}</span>
      </div>
    }
  </div>

  <!-- Stepper -->
  <div class="stepper-container" [class.hidden]="(isCompleted$ | async)">
    <div class="stepper">
      <!-- Step 1 -->
      <div class="step-wrapper">
        <div [class]="(currentStep$ | async)! > 0 ? 'step-circle completed' : ((currentStep$ | async)! === 0 ? 'step-circle active' : 'step-circle')">
          @if ((currentStep$ | async)! > 0) {
            <span nz-icon nzType="check" nzTheme="outline"></span>
          } @else {
            1
          }
        </div>
        <span [class]="(currentStep$ | async)! > 0 ? 'step-label completed' : ((currentStep$ | async)! === 0 ? 'step-label active' : 'step-label')">Cuenta</span>
      </div>

      <div [class]="(currentStep$ | async)! > 0 ? 'step-line completed' : 'step-line'"></div>

      <!-- Step 2 -->
      <div class="step-wrapper">
        <div [class]="(currentStep$ | async)! > 1 ? 'step-circle completed' : ((currentStep$ | async)! === 1 ? 'step-circle active' : 'step-circle')">
          @if ((currentStep$ | async)! > 1) {
            <span nz-icon nzType="check" nzTheme="outline"></span>
          } @else {
            2
          }
        </div>
        <span [class]="(currentStep$ | async)! > 1 ? 'step-label completed' : ((currentStep$ | async)! === 1 ? 'step-label active' : 'step-label')">Experiencia</span>
      </div>

      <div [class]="(currentStep$ | async)! > 1 ? 'step-line completed' : 'step-line'"></div>

      <!-- Step 3 -->
      <div class="step-wrapper">
        <div [class]="(currentStep$ | async)! === 2 ? 'step-circle active' : 'step-circle'">3</div>
        <span [class]="(currentStep$ | async)! === 2 ? 'step-label active' : 'step-label'">Revisión</span>
      </div>
    </div>
    <p class="step-indicator">Paso {{ (currentStep$ | async)! + 1 }} de 3</p>
  </div>

  <!-- Formularios de Onboarding -->
  <div [class.hidden]="(isCompleted$ | async)">
    <!-- Form Card -->
    @if ((currentStep$ | async)! === 0) {
      <div class="form-card">
      <h2 class="form-title">Información Personal</h2>
      
      <!-- Alerta de ayuda -->
      <div class="form-alert">
        <nz-alert
          nzType="info"
          nzMessage="Completa tu perfil profesional"
          nzDescription="Esta información ayudará a los reclutadores a conocerte mejor. Sé claro y conciso."
          nzShowIcon
          nzCloseable
        ></nz-alert>
      </div>

      <form [formGroup]="accountForm" class="account-form">
        <!-- Row 1: Nombre Completo -->
        <div class="form-field">
          <label for="fullName" class="field-label">Nombre de perfil</label>
          <input
            id="fullName"
            type="text"
            class="field-input disabled"
            formControlName="fullName"
            placeholder="Tu nombre"
            readonly
          />
          <span class="field-hint">Este dato proviene de tu nombre de cuenta</span>
        </div>

        <!-- Resumen Profesional -->
        <div class="form-field">
          <label for="summary" class="field-label">Resumen Profesional <span class="required">*</span></label>
          <textarea
            id="summary"
            class="field-textarea"
            [class.error]="hasError(accountForm, 'summary')"
            formControlName="summary"
            placeholder="Cuéntanos un poco sobre tu trayectoria y lo que buscas..."
            rows="4"
          ></textarea>
          <div class="field-footer">
            @if (hasError(accountForm, 'summary')) {
              <div class="error-message">
                <span nz-icon nzType="exclamation-circle" nzTheme="fill"></span>
                {{ getErrorMessage(accountForm, 'summary') }}
              </div>
            }
            <span class="char-count" [class.warning]="(accountForm.get('summary')?.value?.length || 0) < 10">
              {{ accountForm.get('summary')?.value?.length || 0 }} / 500 caracteres
              @if ((accountForm.get('summary')?.value?.length || 0) < 10) {
                <span class="min-chars">(mínimo 10)</span>
              }
            </span>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="form-actions">
          <button type="button" class="submit-button" (click)="saveAndContinue()" [disabled]="accountForm.invalid || isSummaryTooShort || (isLoading$ | async)">
            Guardar y Siguiente
            <span nz-icon nzType="arrow-right" nzTheme="outline"></span>
          </button>
        </div>
      </form>
    </div>
  }

  <!-- Paso 2: Experiencia -->
  @if ((currentStep$ | async)! === 1) {
    <div class="step-container">
      <!-- Experiencias Laborales -->
      <h2 class="step-section-title">Experiencia Laboral</h2>
      
      <!-- Alerta de ayuda -->
      <nz-alert
        nzType="info"
        nzMessage="Agrega tu experiencia profesional"
        nzDescription="Incluye al menos una experiencia laboral. Sé específico con tus responsabilidades y logros."
        nzShowIcon
        nzCloseable
        style="margin-bottom: 1.5rem;"
      ></nz-alert>

      <form [formGroup]="experienceForm">
        <div class="experience-list-compact">
          @if (experiences.length === 0) {
            <div class="experience-empty">
              Aún no agregas experiencias. Usa el boton para crear una nueva.
            </div>
          }
          @for (exp of experiences.controls; track $index; let i = $index) {
            <div class="experience-row" [class.incomplete]="exp.invalid">
              <div class="experience-main">
                <div class="experience-title">
                  {{ exp.get('jobTitle')?.value || 'Sin titulo' }}
                  @if (exp.invalid) {
                    <span class="exp-status pending">Pendiente</span>
                  }
                </div>
                <div class="experience-meta">
                  <span>{{ exp.get('company')?.value || 'Sin empresa' }}</span>
                  <span>•</span>
                  <span>
                    {{ exp.get('startDate')?.value || 'Inicio' }} -
                    {{ exp.get('isCurrent')?.value ? 'Presente' : (exp.get('endDate')?.value || 'Fin') }}
                  </span>
                </div>
              </div>
              <div class="experience-actions-compact">
                <button type="button" class="action-link edit" (click)="openExperienceModal(i)">Editar</button>
                <button type="button" class="action-link delete" (click)="removeExperience(i)">Eliminar</button>
              </div>
            </div>
          }
        </div>

        <button type="button" class="add-button" (click)="addExperience()">
          <span nz-icon nzType="plus" nzTheme="outline"></span>
          Agregar experiencia
        </button>
      </form>

      <nz-modal
        [(nzVisible)]="isExperienceModalVisible"
        nzTitle="Experiencia laboral"
        (nzOnCancel)="closeExperienceModal()"
        [nzFooter]="experienceModalFooter">
        <ng-container *nzModalContent>
          @if (experienceModalForm) {
            <form [formGroup]="experienceModalForm" class="experience-modal-form">
              <div class="field-row">
                <div class="form-field">
                  <label class="field-label">Título del Puesto <span class="required">*</span></label>
                  <input
                    type="text"
                    formControlName="jobTitle"
                    class="field-input"
                    [class.error]="hasError(experienceModalForm, 'jobTitle')"
                    placeholder="Ingeniero de Software Senior" />
                  @if (hasError(experienceModalForm, 'jobTitle')) {
                    <div class="error-message-inline">
                      <span nz-icon nzType="exclamation-circle" nzTheme="fill"></span>
                      {{ getErrorMessage(experienceModalForm, 'jobTitle') }}
                    </div>
                  }
                </div>
                <div class="form-field">
                  <label class="field-label">Empresa <span class="required">*</span></label>
                  <input
                    type="text"
                    formControlName="company"
                    class="field-input"
                    [class.error]="hasError(experienceModalForm, 'company')"
                    placeholder="Tech Solutions Inc." />
                  @if (hasError(experienceModalForm, 'company')) {
                    <div class="error-message-inline">
                      <span nz-icon nzType="exclamation-circle" nzTheme="fill"></span>
                      {{ getErrorMessage(experienceModalForm, 'company') }}
                    </div>
                  }
                </div>
              </div>

              <div class="field-row date-row">
                <div class="form-field">
                  <label class="field-label">Fecha de Inicio <span class="required">*</span></label>
                  <input
                    type="month"
                    formControlName="startDate"
                    class="field-input"
                    [class.error]="hasError(experienceModalForm, 'startDate')" />
                  @if (hasError(experienceModalForm, 'startDate')) {
                    <div class="error-message-inline">
                      <span nz-icon nzType="exclamation-circle" nzTheme="fill"></span>
                      {{ getErrorMessage(experienceModalForm, 'startDate') }}
                    </div>
                  }
                </div>
                <div class="form-field">
                  <label class="field-label">Fecha de Fin</label>
                  <input type="month" formControlName="endDate" class="field-input" />
                </div>
              </div>

              <div class="checkbox-field">
                <label class="checkbox-label">
                  <input type="checkbox" formControlName="isCurrent" class="field-checkbox" />
                  <span>Trabajo actual</span>
                </label>
              </div>

              <div class="form-field">
                <label class="field-label">Descripción <span class="required">*</span></label>
                <textarea
                  formControlName="description"
                  class="field-textarea"
                  [class.error]="hasError(experienceModalForm, 'description')"
                  rows="3"
                  placeholder="Describe tus responsabilidades y logros..."></textarea>
                <div class="field-footer">
                  @if (hasError(experienceModalForm, 'description')) {
                    <div class="error-message-inline">
                      <span nz-icon nzType="exclamation-circle" nzTheme="fill"></span>
                      {{ getErrorMessage(experienceModalForm, 'description') }}
                    </div>
                  }
                  <span class="char-count-small">
                    {{ experienceModalForm.get('description')?.value?.length || 0 }} / 500
                  </span>
                </div>
              </div>
            </form>
          }
        </ng-container>
      </nz-modal>
      <ng-template #experienceModalFooter>
        <button nz-button nzType="default" (click)="closeExperienceModal()">Cancelar</button>
        <button nz-button nzType="primary" (click)="saveExperienceModal()" [disabled]="experienceModalForm.invalid">
          Guardar experiencia
        </button>
      </ng-template>

      <!-- Habilidades -->
      <h2 class="step-section-title">Habilidades</h2>
      
      <div class="skills-card">
        <div class="skill-input-wrapper">
          <span nz-icon nzType="search" nzTheme="outline" class="search-icon"></span>
          <input 
            type="text" 
            class="skill-input" 
            placeholder="Añade una habilidad y presiona Enter"
            (keydown)="addSkill($event)"
          />
        </div>

        <div class="skills-list">
          @for (skill of skills; track skill) {
            <span class="skill-tag">
              {{ skill }}
              <button type="button" class="skill-remove" (click)="removeSkill(skill)">
                <span nz-icon nzType="close" nzTheme="outline"></span>
              </button>
            </span>
          }
        </div>
      </div>

      <!-- Navigation Buttons -->
      <div class="form-navigation">
        <button type="button" class="nav-button secondary" (click)="previousStep()">
          Atrás
        </button>
        <button type="button" class="nav-button primary" (click)="saveAndContinue()" [disabled]="experienceForm.invalid || skills.length === 0 || (isLoading$ | async)">
          Guardar y Siguiente
        </button>
      </div>
    </div>
  }

  <!-- Paso 3: Revisión -->
  @if ((currentStep$ | async)! === 2) {
    <div class="review-container">
      <div class="review-grid">
        <div class="cv-preview">
          <div class="cv-sheet">
            <div class="cv-sheet-content">
              <div class="cv-header">
                <div class="cv-photo">
                  <span nz-icon nzType="user" nzTheme="outline"></span>
                </div>
                <div class="cv-header-info">
                  <h2 class="cv-name">{{ accountForm.get('fullName')?.value || 'Tu Nombre' }}</h2>
                  <p class="cv-role">
                    {{ ((resumeData.experiences && resumeData.experiences.length > 0) ? (resumeData.experiences[0].jobTitle || resumeData.experiences[0].position) : '') || 'Perfil profesional' }}
                  </p>
                  <p class="cv-subline">Perfil generado en Vertex</p>
                </div>
              </div>

              <section class="cv-section">
                <h3 class="cv-section-title">Resumen profesional</h3>
                <p class="cv-text">{{ accountForm.get('summary')?.value || 'Agrega un resumen profesional para destacar tu perfil.' }}</p>
              </section>

              <section class="cv-section">
                <h3 class="cv-section-title">Experiencia</h3>
                <div class="cv-experience-list">
                  @for (exp of (resumeData.experiences || []); track $index; let i = $index) {
                    <div class="cv-entry" [class.first]="i === 0">
                      <div class="cv-entry-header">
                        <div class="cv-entry-title">
                          <span class="cv-entry-role">{{ (exp.jobTitle || exp.position) || 'Sin título' }}</span>
                          <span class="cv-entry-company">{{ exp.company || 'Sin empresa' }}</span>
                        </div>
                        <span class="cv-entry-date">
                          @if (exp.startDate) {
                            {{ exp.startDate | date: 'MMM yyyy' }}
                          } @else {
                            Fecha inicio
                          }
                          -
                          @if (exp.isCurrent) {
                            Presente
                          } @else if (exp.endDate) {
                            {{ exp.endDate | date: 'MMM yyyy' }}
                          } @else {
                            Fecha fin
                          }
                        </span>
                      </div>
                      @if (exp.description) {
                        <p class="cv-entry-description">{{ exp.description }}</p>
                      }
                    </div>
                  }
                  @if ((resumeData.experiences || []).length === 0) {
                    <p class="cv-empty">Agrega experiencia para verla reflejada aqui.</p>
                  }
                </div>
              </section>

              <section class="cv-section">
                <h3 class="cv-section-title">Habilidades</h3>
                <div class="cv-skills">
                  @for (skill of skills; track skill) {
                    <span class="cv-skill-tag">{{ skill }}</span>
                  }
                  @if (skills.length === 0) {
                    <span class="cv-empty">Agrega habilidades para destacarlas.</span>
                  }
                </div>
              </section>
            </div>
          </div>
        </div>

        <div class="summary-sidebar">
          <div class="summary-card">
            <h3 class="summary-card-title">Información Personal</h3>
            <div class="summary-card-content">
              <div class="summary-item">
                <span class="summary-label">Nombre:</span>
                <span class="summary-value">{{ accountForm.get('fullName')?.value }}</span>
              </div>
            </div>
          </div>

          <div class="summary-card">
            <h3 class="summary-card-title">Experiencia Laboral</h3>
            <div class="summary-card-content">
              @for (exp of experiences.controls; track $index; let i = $index) {
                <div class="summary-exp-item" [class.last]="$index === experiences.controls.length - 1">
                  <p class="summary-exp-title">{{ exp.get('jobTitle')?.value }}</p>
                  <p class="summary-exp-company">{{ exp.get('company')?.value }}</p>
                </div>
              }
            </div>
          </div>

          <div class="summary-card">
            <h3 class="summary-card-title">Habilidades</h3>
            <div class="summary-skills">
              @for (skill of skills; track skill) {
                <span class="summary-skill-tag">{{ skill }}</span>
              }
            </div>
          </div>

          <div class="review-actions">
            <button type="button" class="nav-button secondary full-width" (click)="previousStep()">
              Atrás
            </button>
            <button type="button" class="nav-button primary full-width" (click)="finishOnboarding()" [disabled]="!canFinishOnboarding || (isLoading$ | async)">
              Finalizar y Enviar
            </button>
          </div>
        </div>
      </div>
    </div>
  }

  </div>
  <!-- Fin Formularios de Onboarding -->

  </main>
  <!-- Footer -->
  <app-footer />
