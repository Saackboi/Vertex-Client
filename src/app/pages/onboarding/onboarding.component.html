
<!-- Header -->
<header class="onboarding-header">
  <div class="header-container">
    <!-- Logo -->
    <app-logo route="/dashboard" />

    <!-- Navigation -->
    <div class="nav-section">
      <nav class="nav-links">
        <a (click)="navigateToNotifications()">Notificaciones</a>
      </nav>

      <div class="action-buttons">
        <button class="icon-button" (click)="toggleDarkMode()">
          <span nz-icon [nzType]="isDarkMode ? 'sun' : 'moon'" nzTheme="outline"></span>
        </button>
        <button class="icon-button" (click)="navigateToNotifications()">
          <nz-badge [nzCount]="(notificationCount$ | async) ?? 0">
            <span nz-icon nzType="bell" nzTheme="outline"></span>
          </nz-badge>
        </button>
        <nz-avatar 
          nz-dropdown 
          [nzDropdownMenu]="userMenu" 
          nzPlacement="bottomRight"
          nzIcon="user" 
          [nzSize]="32"
          class="user-avatar">
        </nz-avatar>
        <nz-dropdown-menu #userMenu="nzDropdownMenu">
          <ul nz-menu>
            <li nz-menu-item>
              <span nz-icon nzType="user" nzTheme="outline"></span>
              {{ userFullName$ | async }}
            </li>
            <li nz-menu-divider></li>
            <li nz-menu-item (click)="logout()">
              <span nz-icon nzType="logout" nzTheme="outline"></span>
              Cerrar Sesión
            </li>
          </ul>
        </nz-dropdown-menu>
      </div>
    </div>
  </div>
</header>

<!-- Main Content -->
<main class="onboarding-main">
  <!-- Alerta de Error -->
  @if ((errorMessage$ | async)) {
    <div class="error-alert-container">
      <nz-alert
        nzType="error"
        [nzMessage]="(errorMessage$ | async)"
        nzShowIcon
        nzCloseable
        (nzOnClose)="clearError()"
        class="error-alert"
      ></nz-alert>
    </div>
  }

  <!-- Alerta de Onboarding Completado -->
  @if ((isCompleted$ | async)) {
    <div class="completed-container">
      <!-- Hero Section -->
      <div class="completed-hero">
        <div class="hero-icon">
          <span nz-icon nzType="check-circle" nzTheme="fill"></span>
        </div>
        <h1 class="hero-title">¡Perfil Completado!</h1>
        <p class="hero-description">
          Tu perfil profesional está listo y visible para reclutadores.
        </p>
      </div>

      <!-- Profile Summary Card -->
      <div class="profile-summary-card">
        <div class="summary-header">
          <h2 class="summary-title">
            <span nz-icon nzType="user" nzTheme="outline"></span>
            Resumen de tu Perfil
          </h2>
        </div>

        <div class="summary-content">
          <!-- Información Personal -->
          <div class="info-section">
            <h3 class="section-label">
              <span nz-icon nzType="idcard" nzTheme="outline"></span>
              Información Personal
            </h3>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">Nombre:</span>
                <span class="info-value">{{ accountForm.get('fullName')?.value || 'No especificado' }}</span>
              </div>
              <div class="info-item full-width">
                <span class="info-label">Resumen Profesional:</span>
                <p class="info-value summary-text">{{ accountForm.get('summary')?.value || 'No especificado' }}</p>
              </div>
            </div>
          </div>

          <!-- Experiencia -->
          @if (experiences.length > 0) {
            <div class="info-section">
              <h3 class="section-label">
                <span nz-icon nzType="solution" nzTheme="outline"></span>
                Experiencia Laboral ({{ experiences.length }})
              </h3>
              <div class="experience-list">
                @for (exp of experiences.controls; track $index) {
                  <div class="experience-item">
                    <div class="exp-header">
                      <span class="exp-role">{{ exp.get('jobTitle')?.value }}</span>
                      <span class="exp-company">{{ exp.get('company')?.value }}</span>
                    </div>
                    <div class="exp-dates">
                      <span nz-icon nzType="calendar" nzTheme="outline"></span>
                      {{ exp.get('startDate')?.value || 'Fecha no especificada' }}
                      -
                      {{ exp.get('isCurrent')?.value ? 'Presente' : (exp.get('endDate')?.value || 'Fecha no especificada') }}
                    </div>
                    @if (exp.get('description')?.value) {
                      <p class="exp-description">{{ exp.get('description')?.value }}</p>
                    }
                  </div>
                }
              </div>
            </div>
          }

          <!-- Habilidades -->
          @if (skills && skills.length > 0) {
            <div class="info-section">
              <h3 class="section-label">
                <span nz-icon nzType="tags" nzTheme="outline"></span>
                Habilidades ({{ skills.length }})
              </h3>
              <div class="skills-tags">
                @for (skill of skills; track skill) {
                  <span class="skill-tag">{{ skill }}</span>
                }
              </div>
            </div>
          }
        </div>

        <!-- Action Buttons -->
        <div class="summary-actions">
          <button nz-button nzType="primary" nzSize="large" (click)="navigateToDashboard()">
            <span nz-icon nzType="home" nzTheme="outline"></span>
            Ir al Dashboard
          </button>
        </div>
      </div>

      <!-- Info Footer -->
      <div class="info-footer">
        <span nz-icon nzType="info-circle" nzTheme="outline"></span>
        <p>¿Necesitas hacer cambios? Puedes editar tu perfil en cualquier momento desde la sección de <strong>Perfil</strong>.</p>
      </div>
    </div>
  }

  <!-- Page Header -->
  <div class="page-header" [class.hidden]="(isCompleted$ | async)">
    <div class="page-title-section">
      <h1 class="page-title">Configuración de Cuenta</h1>
      @if ((isCompleted$ | async)) {
        <span class="completed-badge">
          <span nz-icon nzType="check-circle" nzTheme="fill"></span>
          Completado
        </span>
      }
    </div>
    @if ((lastSaved$ | async) && !(isCompleted$ | async)) {
      <div class="autosave-badge">
        <span nz-icon nzType="check-circle" nzTheme="outline"></span>
        <span class="badge-text">Borrador guardado automáticamente {{ (lastSaved$ | async) }}</span>
      </div>
    }
  </div>

  <!-- Stepper -->
  <div class="stepper-container" [class.hidden]="(isCompleted$ | async)">
    <div class="stepper">
      <!-- Step 1 -->
      <div class="step-wrapper">
        <div [class]="(currentStep$ | async)! > 0 ? 'step-circle completed' : ((currentStep$ | async)! === 0 ? 'step-circle active' : 'step-circle')">
          @if ((currentStep$ | async)! > 0) {
            <span nz-icon nzType="check" nzTheme="outline"></span>
          } @else {
            1
          }
        </div>
        <span [class]="(currentStep$ | async)! > 0 ? 'step-label completed' : ((currentStep$ | async)! === 0 ? 'step-label active' : 'step-label')">Cuenta</span>
      </div>

      <div [class]="(currentStep$ | async)! > 0 ? 'step-line completed' : 'step-line'"></div>

      <!-- Step 2 -->
      <div class="step-wrapper">
        <div [class]="(currentStep$ | async)! > 1 ? 'step-circle completed' : ((currentStep$ | async)! === 1 ? 'step-circle active' : 'step-circle')">
          @if ((currentStep$ | async)! > 1) {
            <span nz-icon nzType="check" nzTheme="outline"></span>
          } @else {
            2
          }
        </div>
        <span [class]="(currentStep$ | async)! > 1 ? 'step-label completed' : ((currentStep$ | async)! === 1 ? 'step-label active' : 'step-label')">Experiencia</span>
      </div>

      <div [class]="(currentStep$ | async)! > 1 ? 'step-line completed' : 'step-line'"></div>

      <!-- Step 3 -->
      <div class="step-wrapper">
        <div [class]="(currentStep$ | async)! === 2 ? 'step-circle active' : 'step-circle'">3</div>
        <span [class]="(currentStep$ | async)! === 2 ? 'step-label active' : 'step-label'">Revisión</span>
      </div>
    </div>
    <p class="step-indicator">Paso {{ (currentStep$ | async)! + 1 }} de 3</p>
  </div>

  <!-- Formularios de Onboarding -->
  <div [class.hidden]="(isCompleted$ | async)">
    <!-- Form Card -->
    @if ((currentStep$ | async)! === 0) {
      <div class="form-card">
      <h2 class="form-title">Información Personal</h2>
      
      <!-- Alerta de ayuda -->
      <nz-alert
        nzType="info"
        nzMessage="Completa tu perfil profesional"
        nzDescription="Esta información ayudará a los reclutadores a conocerte mejor. Sé claro y conciso."
        nzShowIcon
        nzCloseable
        style="margin-bottom: 1.5rem;"
      ></nz-alert>

      <form [formGroup]="accountForm" class="account-form">
        <!-- Row 1: Nombre Completo -->
        <div class="form-field">
          <label for="fullName" class="field-label">Nombre de perfil</label>
          <input
            id="fullName"
            type="text"
            class="field-input disabled"
            formControlName="fullName"
            placeholder="Tu nombre"
            readonly
          />
          <span class="field-hint">Este dato proviene de tu nombre de cuenta</span>
        </div>

        <!-- Resumen Profesional -->
        <div class="form-field">
          <label for="summary" class="field-label">Resumen Profesional <span class="required">*</span></label>
          <textarea
            id="summary"
            class="field-textarea"
            [class.error]="hasError(accountForm, 'summary')"
            formControlName="summary"
            placeholder="Cuéntanos un poco sobre tu trayectoria y lo que buscas..."
            rows="4"
          ></textarea>
          <div class="field-footer">
            @if (hasError(accountForm, 'summary')) {
              <div class="error-message">
                <span nz-icon nzType="exclamation-circle" nzTheme="fill"></span>
                {{ getErrorMessage(accountForm, 'summary') }}
              </div>
            }
            <span class="char-count" [class.warning]="(accountForm.get('summary')?.value?.length || 0) < 50">
              {{ accountForm.get('summary')?.value?.length || 0 }} / 500 caracteres
              @if ((accountForm.get('summary')?.value?.length || 0) < 50) {
                <span class="min-chars">(mínimo 50)</span>
              }
            </span>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="form-actions">
          <button type="button" class="submit-button" (click)="saveAndContinue()" [disabled]="accountForm.invalid || (isLoading$ | async)">
            Guardar y Siguiente
            <span nz-icon nzType="arrow-right" nzTheme="outline"></span>
          </button>
        </div>
      </form>
    </div>
  }

  <!-- Paso 2: Experiencia -->
  @if ((currentStep$ | async)! === 1) {
    <div class="step-container">
      <!-- Experiencias Laborales -->
      <h2 class="step-section-title">Experiencia Laboral</h2>
      
      <!-- Alerta de ayuda -->
      <nz-alert
        nzType="info"
        nzMessage="Agrega tu experiencia profesional"
        nzDescription="Incluye al menos una experiencia laboral. Sé específico con tus responsabilidades y logros."
        nzShowIcon
        nzCloseable
        style="margin-bottom: 1.5rem;"
      ></nz-alert>

      <form [formGroup]="experienceForm">
        <div formArrayName="experiences" class="experiences-list">
          @for (exp of experiences.controls; track $index; let i = $index) {
            <div [formGroupName]="i" class="experience-card">
              <div class="experience-indicator"></div>
              
              <div class="experience-content">
                <div class="experience-fields">
                  <div class="field-row">
                    <div class="form-field">
                      <label class="field-label">Título del Puesto <span class="required">*</span></label>
                      <input 
                        type="text" 
                        formControlName="jobTitle" 
                        class="field-input" 
                        [class.error]="hasExperienceError(i, 'jobTitle')"
                        placeholder="Ingeniero de Software Senior" />
                      @if (hasExperienceError(i, 'jobTitle')) {
                        <div class="error-message-inline">
                          <span nz-icon nzType="exclamation-circle" nzTheme="fill"></span>
                          {{ getExperienceErrorMessage(i, 'jobTitle') }}
                        </div>
                      }
                    </div>
                    <div class="form-field">
                      <label class="field-label">Empresa <span class="required">*</span></label>
                      <input 
                        type="text" 
                        formControlName="company" 
                        class="field-input" 
                        [class.error]="hasExperienceError(i, 'company')"
                        placeholder="Tech Solutions Inc." />
                      @if (hasExperienceError(i, 'company')) {
                        <div class="error-message-inline">
                          <span nz-icon nzType="exclamation-circle" nzTheme="fill"></span>
                          {{ getExperienceErrorMessage(i, 'company') }}
                        </div>
                      }
                    </div>
                  </div>

                  <div class="field-row date-row">
                    <div class="form-field">
                      <label class="field-label">Fecha de Inicio <span class="required">*</span></label>
                      <input 
                        type="month" 
                        formControlName="startDate" 
                        class="field-input"
                        [class.error]="hasExperienceError(i, 'startDate')" />
                      @if (hasExperienceError(i, 'startDate')) {
                        <div class="error-message-inline">
                          <span nz-icon nzType="exclamation-circle" nzTheme="fill"></span>
                          {{ getExperienceErrorMessage(i, 'startDate') }}
                        </div>
                      }
                    </div>
                    <div class="form-field">
                      <label class="field-label">Fecha de Fin</label>
                      <input 
                        type="month" 
                        formControlName="endDate" 
                        class="field-input" />
                    </div>
                  </div>

                  <div class="checkbox-field">
                    <label class="checkbox-label">
                      <input type="checkbox" formControlName="isCurrent" class="field-checkbox" />
                      <span>Trabajo actual</span>
                    </label>
                  </div>

                  <div class="form-field">
                    <label class="field-label">Descripción <span class="required">*</span></label>
                    <textarea 
                      formControlName="description" 
                      class="field-textarea" 
                      [class.error]="hasExperienceError(i, 'description')"
                      rows="3" 
                      placeholder="Describe tus responsabilidades y logros..."></textarea>
                    <div class="field-footer">
                      @if (hasExperienceError(i, 'description')) {
                        <div class="error-message-inline">
                          <span nz-icon nzType="exclamation-circle" nzTheme="fill"></span>
                          {{ getExperienceErrorMessage(i, 'description') }}
                        </div>
                      }
                      <span class="char-count-small">
                        {{ exp.get('description')?.value?.length || 0 }} / 500
                      </span>
                    </div>
                  </div>
                </div>

                <div class="experience-actions">
                  <button type="button" class="action-button delete" (click)="removeExperience(i)">
                    <span nz-icon nzType="delete" nzTheme="outline"></span>
                    Eliminar
                  </button>
                </div>
              </div>
            </div>
          }
        </div>

        <button type="button" class="add-button" (click)="addExperience()">
          <span nz-icon nzType="plus" nzTheme="outline"></span>
          Agregar experiencia
        </button>
      </form>

      <!-- Habilidades -->
      <h2 class="step-section-title">Habilidades</h2>
      
      <div class="skills-card">
        <div class="skill-input-wrapper">
          <span nz-icon nzType="search" nzTheme="outline" class="search-icon"></span>
          <input 
            type="text" 
            class="skill-input" 
            placeholder="Añade una habilidad y presiona Enter"
            (keydown)="addSkill($event)"
          />
        </div>

        <div class="skills-list">
          @for (skill of skills; track skill) {
            <span class="skill-tag">
              {{ skill }}
              <button type="button" class="skill-remove" (click)="removeSkill(skill)">
                <span nz-icon nzType="close" nzTheme="outline"></span>
              </button>
            </span>
          }
        </div>
      </div>

      <!-- Navigation Buttons -->
      <div class="form-navigation">
        <button type="button" class="nav-button secondary" (click)="previousStep()">
          Atrás
        </button>
        <button type="button" class="nav-button primary" (click)="saveAndContinue()" [disabled]="experienceForm.invalid || skills.length === 0 || (isLoading$ | async)">
          Guardar y Siguiente
        </button>
      </div>
    </div>
  }

  <!-- Paso 3: Revisión -->
  @if ((currentStep$ | async)! === 2) {
    <div class="review-container">
      <div class="review-grid">
        <!-- Columna izquierda: CV Preview -->
        <div class="cv-preview">
          <div class="cv-header">
            <h2 class="cv-title">Resumen de tu Perfil</h2>
            <p class="cv-subtitle">Vista previa de tu información profesional</p>
          </div>

          <div class="cv-content">
            <!-- Información Personal -->
            <section class="cv-section">
              <h3 class="cv-section-title">INFORMACIÓN PERSONAL</h3>
              <div class="cv-info-grid">
                <div class="cv-info-item">
                  <p class="cv-info-label">Nombre Completo</p>
                  <p class="cv-info-value">{{ accountForm.get('fullName')?.value }}</p>
                </div>
              </div>
              <div class="cv-summary">
                <p class="cv-info-label">Resumen Profesional</p>
                <p class="cv-info-value">{{ accountForm.get('summary')?.value }}</p>
              </div>
            </section>

            <!-- Experiencia Laboral -->
            <section class="cv-section">
              <h3 class="cv-section-title">EXPERIENCIA LABORAL</h3>
              <div class="cv-experience-list">
                @for (exp of (resumeData.experiences || []); track $index; let i = $index) {
                  <div class="cv-experience-item" [class.first]="i === 0">
                    <div class="cv-exp-header">
                      <h4 class="cv-exp-title">{{ (exp.jobTitle || exp.position) || 'Sin título' }}</h4>
                      <span class="cv-exp-date">
                        @if (exp.startDate) {
                          {{ exp.startDate | date: 'MMM yyyy' }}
                        } @else {
                          Fecha inicio
                        }
                        -
                        @if (exp.isCurrent) {
                          Presente
                        } @else if (exp.endDate) {
                          {{ exp.endDate | date: 'MMM yyyy' }}
                        } @else {
                          Fecha fin
                        }
                      </span>
                    </div>
                    <p class="cv-exp-company">{{ exp.company || 'Sin empresa' }}</p>
                    @if (exp.description) {
                      <p class="cv-exp-description">{{ exp.description }}</p>
                    }
                  </div>
                }
              </div>
            </section>
          </div>
        </div>

        <!-- Columna derecha: Resumen Cards -->
        <div class="summary-sidebar">
          <!-- Card: Información Personal -->
          <div class="summary-card">
            <h3 class="summary-card-title">Información Personal</h3>
            <div class="summary-card-content">
              <div class="summary-item">
                <span class="summary-label">Nombre:</span>
                <span class="summary-value">{{ accountForm.get('fullName')?.value }}</span>
              </div>
            </div>
          </div>

          <!-- Card: Experiencia Laboral -->
          <div class="summary-card">
            <h3 class="summary-card-title">Experiencia Laboral</h3>
            <div class="summary-card-content">
              @for (exp of experiences.controls; track $index; let i = $index) {
                <div class="summary-exp-item" [class.last]="$index === experiences.controls.length - 1">
                  <p class="summary-exp-title">{{ exp.get('jobTitle')?.value }}</p>
                  <p class="summary-exp-company">{{ exp.get('company')?.value }}</p>
                </div>
              }
            </div>
          </div>

          <!-- Card: Habilidades -->
          <div class="summary-card">
            <h3 class="summary-card-title">Habilidades</h3>
            <div class="summary-skills">
              @for (skill of skills; track skill) {
                <span class="summary-skill-tag">{{ skill }}</span>
              }
            </div>
          </div>

          <!-- Botones de navegación -->
          <div class="review-actions">
            <button type="button" class="nav-button secondary full-width" (click)="previousStep()">
              Atrás
            </button>
            <button type="button" class="nav-button primary full-width" (click)="finishOnboarding()" [disabled]="!canFinishOnboarding || (isLoading$ | async)">
              Finalizar y Enviar
            </button>
          </div>
        </div>
      </div>
    </div>
  }

  </div>
  <!-- Fin Formularios de Onboarding -->

  <!-- Footer -->
  <app-footer />
</main>
